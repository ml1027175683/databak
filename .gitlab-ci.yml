variables:
  PROJECT_NAME: ship/data-center
  APP_NAME: data-center
  APP_GROUP: ship
  APP_GROUP_ARM: arm64

stages:
  - package
  - docker-build
  - docker-build-arm
  - deploy-dev

# Maven æ„å»ºé˜¶æ®µ
package:
  stage: package
  image: harbor.moonsailtech.com/library/maven/msz-maven-image:v1.0.1
  tags:
    - package
  variables:
    MAVEN_OPTS: "-Dmaven.repo.local=/cache/repository"
    MAVEN_CLI_OPTS: "-s /root/.m2/settings.xml --batch-mode"
  script:
    - mkdir -p /cache/repository
    - mvn clean package -DskipTests -T 4  # å¹¶è¡Œæ„å»ºåŠ é€Ÿ
    - cp target/*.jar target/app.jar
  cache:
    key: "$CI_COMMIT_REF_SLUG-maven"
    paths:
      - /cache/repository
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 day

# Docker é•œåƒæ„å»ºé˜¶æ®µ
docker-build:
  stage: docker-build
  image: harbor.moonsailtech.com/library/docker/msz-docker-image:latest
  tags:
    - docker-build
  script:
    - echo "ğŸš€ å¼€å§‹æ„å»º Docker é•œåƒ ..."
    - export version=$CI_COMMIT_REF_NAME
    - export app=$CI_PROJECT_NAME
    - ls -al ./
    - ls /
    - echo "ğŸš€ æŸ¥targetæ–‡ä»¶ ..."
    - ls -l target/
    - version=$APP_NAME-$(date "+%Y%m%d")-$version-$CI_PIPELINE_ID
    - docker login harbor.moonsailtech.com -u admin -p Harbor12345
    - docker build -t harbor.moonsailtech.com/$APP_GROUP/$APP_NAME:$version .
    - docker images | grep $APP_NAME
    - test -z "$(docker images | grep $APP_NAME | grep $version)" && exit -1
    - docker push harbor.moonsailtech.com/$APP_GROUP/$APP_NAME:$version
    - echo "ğŸš€ æ¨é€ Docker é•œåƒæˆåŠŸ ..."
docker-build-arm:
  stage: docker-build-arm
  image: harbor.moonsailtech.com/library/docker/msz-docker-image:latest
  tags:
    - docker-build-arm
  script:
    - echo "ğŸš€ å¼€å§‹æ„å»º Docker é•œåƒ ..."
    - export version=$CI_COMMIT_REF_NAME
    - export app=$CI_PROJECT_NAME
    - docker buildx use default
    - docker buildx ls
    - docker login harbor.moonsailtech.com -u admin -p Harbor12345
    - version=$APP_NAME-$(date "+%Y%m%d")-$version-$CI_PIPELINE_ID
    - docker buildx build --platform linux/arm64 -t harbor.moonsailtech.com/$APP_GROUP_ARM/$APP_NAME:$version --push   .
    - echo "âœ… å¤šå¹³å°é•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸ"
# éƒ¨ç½²é˜¶æ®µ
deploy-dev:
  stage: deploy-dev
  image: alpine:latest
  tags:
    - deploy-dev
  script:
    - echo "ğŸ“¦ æ­£åœ¨éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
    # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…éƒ¨ç½²çš„å‘½ä»¤ï¼Œä¾‹å¦‚ä½¿ç”¨ SSH æˆ– API å°†åº”ç”¨éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
